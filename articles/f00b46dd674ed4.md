---
title: "Laravel ã® insert ãƒ¡ã‚½ãƒƒãƒ‰ã§ SQL Server å‹å¤‰æ›ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ç†ç”±"
emoji: "ğŸ¦Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["php", "laravel","SQL Server"]
published: true
---

## ã¯ã˜ã‚ã«

æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ ã®é–‹ç™ºä¸­ã€SQL Server ã¨ Laravel ã®çµ„ã¿åˆã‚ã›ã§æ¬¡ã®ã‚¨ãƒ©ãƒ¼ã«é­é‡ã—ãŸã€‚DECIMAL å‹ã®ã‚«ãƒ©ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬æŒ¿å…¥ã™ã‚‹éš›ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã®ã§ã‚ã‚‹ã€‚

```
SQLSTATE[22018]: [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]
Conversion failed when converting the nvarchar value '5.75' to data type int.
```

å®Ÿè¡Œç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®šç¾©ã§ã¯`DECIMAL(5,2)`å‹ã€Laravel ã®ãƒ¢ãƒ‡ãƒ«ã§ã¯`'float'`ã¨ã‚­ãƒ£ã‚¹ãƒˆã‚’è¨­å®šã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚‚`'numeric'`ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ã„ãŸã€‚ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€SQL Server ã¯ã€Œnvarchar å€¤ã‚’ int ã«å¤‰æ›ã§ããªã„ã€ã¨è¨´ãˆã¦ãã‚‹ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€ã“ã®å•é¡Œã®åŸå› ã‚’æ˜ã‚Šä¸‹ã’ã€å†ç¾ã‚³ãƒ¼ãƒ‰ã¨ã¨ã‚‚ã«è§£æ±ºç­–ã‚’æç¤ºã™ã‚‹ã€‚

## ç’°å¢ƒæƒ…å ±

- **Laravel**ï¼š12.37.0
- **PHP**ï¼š8.4

## å•é¡Œã®ç™ºç”ŸçŠ¶æ³

### ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå®Ÿè£…

å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã§ã‚ã£ãŸã€‚

```php
// ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬æŒ¿å…¥
$dataToInsert = array_map(
    fn ($item) => [
        'id' => (string) Str::uuid(),
        'related_id' => $relatedId,
        'value' => $item['value'], // ã“ã“ã«å•é¡ŒãŒã‚ã‚‹
    ],
    array_filter($items, fn ($item) => $item['value'] > 0)
);

Model::insert($dataToInsert);
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ä¸€è¦‹å•é¡Œãªã•ãã†ã«è¦‹ãˆã‚‹ã€‚ã—ã‹ã—ã€å€¤ã‚’é »ç¹ã«å¤‰æ›´ã™ã‚‹ãƒ†ã‚¹ãƒˆä¸­ã€æ™‚ã€…ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®šç¾©

```sql
CREATE TABLE sample_table (
    id VARCHAR(36) PRIMARY KEY,
    related_id VARCHAR(36) NOT NULL,
    value DECIMAL(5,2) NOT NULL,  -- DECIMALå‹ã¨ã—ã¦æ­£ã—ãå®šç¾©
    -- ...
);
```

### Eloquent ãƒ¢ãƒ‡ãƒ«å®šç¾©

```php
class SampleModel extends Model
{
    protected $casts = [
        'value' => 'float',  // ã‚­ãƒ£ã‚¹ãƒˆã‚‚è¨­å®šæ¸ˆã¿
    ];
}
```

ã™ã¹ã¦æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã¯ãšãªã®ã«ã€ãªãœã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã‹ã€‚

## åŸå› ã®ç©¶æ˜

### PHP ãƒ¬ãƒ™ãƒ«ã§ã®ãƒ‡ãƒãƒƒã‚°

ã¾ãšã€PHP å´ã§å‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ã‚’ä»•è¾¼ã‚“ã ã€‚

```php
foreach ($dataToInsert as $item) {
    \Log::info('Value type check', [
        'value' => $item['value'],
        'type' => gettype($item['value']),
        'is_int' => is_int($item['value']),
        'is_float' => is_float($item['value']),
    ]);
}
```

çµæœã¯ä»¥ä¸‹ã®é€šã‚Šã§ã‚ã£ãŸã€‚

```
[2025-11-24 11:23:00] Value type check {"value":7.75,"type":"double","is_int":false,"is_float":true}
[2025-11-24 11:23:00] Value type check {"value":5,"type":"integer","is_int":true,"is_float":false}
[2025-11-24 11:23:00] Value type check {"value":6.5,"type":"double","is_int":false,"is_float":true}
```

ã“ã“ã«å•é¡Œã®æ ¸å¿ƒãŒã‚ã£ãŸã€‚**PHP ã®å‹ãŒæ··åœ¨ã—ã¦ã„ã‚‹**ã®ã§ã‚ã‚‹ã€‚

- `7.75` â†’ `double`å‹
- `5` â†’ `integer`å‹
- `6.5` â†’ `double`å‹

### å•é¡Œã®æœ¬è³ª

ã“ã®å•é¡Œã¯ã€ä»¥ä¸‹ã® 3 ã¤ã®è¦å› ãŒçµ„ã¿åˆã‚ã•ã£ã¦ç™ºç”Ÿã™ã‚‹ã€‚

#### 1. PHP ã®å‹ã®è‡ªå‹•åˆ¤å®š

JSON ã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹æ•°å€¤ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è‡ªå‹•çš„ã«å‹ãŒæ±ºå®šã•ã‚Œã‚‹ã€‚

```php
$value1 = 7.75;  // doubleå‹
$value2 = 5;     // integerå‹ï¼ˆå°æ•°éƒ¨ãŒãªã„ãŸã‚ï¼‰
$value3 = 5.0;   // doubleå‹ï¼ˆæ˜ç¤ºçš„ã«å°æ•°éƒ¨ã‚’æŒã¤ï¼‰
```

#### 2. SQL Server ã®å‹å„ªå…ˆé †ä½ã‚·ã‚¹ãƒ†ãƒ 

SQL Server ã«ã¯å‹ã®å„ªå…ˆé †ä½ãŒå­˜åœ¨ã™ã‚‹[^1]ã€‚

```
int > float > decimal
```

åŒä¸€ã‚«ãƒ©ãƒ ã«ç•°ãªã‚‹å‹ã®å€¤ãŒæ··åœ¨ã™ã‚‹å ´åˆã€SQL Server ã¯å„ªå…ˆåº¦ã®é«˜ã„å‹ã«çµ±ä¸€ã—ã‚ˆã†ã¨ã™ã‚‹ã€‚

[^1]: [Microsoft SQL Server Documentation: "Data Type Precedence (Transact-SQL)"](https://learn.microsoft.com/en-us/sql/t-sql/data-types/data-type-precedence-transact-sql)

#### 3. PDO SQL Server ãƒ‰ãƒ©ã‚¤ãƒã®å‹æ¨è«–

`Model::insert()`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€Eloquent ã®ã‚­ãƒ£ã‚¹ãƒˆã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã€‚ãã®ãŸã‚ã€PDO SQL Server ãƒ‰ãƒ©ã‚¤ãƒãŒ PHP ã®å‹ã‹ã‚‰ç›´æ¥ SQL Server ã®å‹ã‚’æ¨è«–ã™ã‚‹ã“ã¨ã«ãªã‚‹ã€‚

ã“ã® 3 ã¤ã®è¦å› ãŒçµ„ã¿åˆã‚ã•ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã€‚

1. PDO ãŒ PHP ã®`integer`å‹ã‚’æ¤œå‡º
2. SQL Server ã®å‹å„ªå…ˆé †ä½ã«ã‚ˆã‚Šã€`int`å‹ã¨ã—ã¦å‡¦ç†ã—ã‚ˆã†ã¨ã™ã‚‹
3. ã—ã‹ã—ä»–ã®å€¤ï¼ˆ`7.75`ãªã©ï¼‰ã¯`int`ã«å¤‰æ›ã§ããªã„
4. çµæœã¨ã—ã¦ nvarcharï¼ˆæ–‡å­—åˆ—ï¼‰ã¨ã—ã¦è§£é‡ˆã•ã‚Œã‚‹
5. nvarchar ã‚’ int ã«å¤‰æ›ã—ã‚ˆã†ã¨ã—ã¦ã‚¨ãƒ©ãƒ¼

### é¡ä¼¼äº‹ä¾‹ã®èª¿æŸ»

ã“ã®å•é¡Œã¯æ—¢çŸ¥ã®ã‚‚ã®ã§ã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ãŸã€‚

#### Laravel Framework Issue #28923

GitHub ã® Laravel ãƒªãƒã‚¸ãƒˆãƒªã§åŒæ§˜ã®å•é¡ŒãŒå ±å‘Šã•ã‚Œã¦ã„ã‚‹[^2]ã€‚

- MSSQL conversion error
- åŸå›  SQL Server ã®å‹å„ªå…ˆé †ä½ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šã€`int`ã®å„ªå…ˆåº¦ãŒé«˜ã„ãŸã‚ä»–ã®å€¤ã‚‚`int`ã«å¤‰æ›ã—ã‚ˆã†ã¨ã™ã‚‹
- çµè«– Laravel å´ã§ã¯å®Œå…¨ã«è§£æ±ºã§ããªã„ã€SQL Server ã®ä»•æ§˜ã«ã‚ˆã‚‹åˆ¶é™

[^2]: [Laravel Framework Issue #28923](https://github.com/laravel/framework/issues/28923)

#### Stack Overflow ã®äº‹ä¾‹

Stack Overflow ã§ã‚‚è¤‡æ•°ã®é¡ä¼¼å ±å‘ŠãŒå­˜åœ¨ã™ã‚‹[^3]ã€‚ç‰¹ã«ã€ŒError converting data type nvarchar to numeric when trying to create a record using Eloquentã€ã¨ã„ã†ã‚¿ã‚¤ãƒˆãƒ«ã®è³ªå•ã§ã¯ã€Laravel ã®`insert()`ã‚„`create()`ä½¿ç”¨æ™‚ã« PDO ã®å‹æ¨è«–ã«ã‚ˆã‚‹å•é¡Œã¨ã—ã¦å ±å‘Šã•ã‚Œã¦ã„ã‚‹ã€‚

[^3]: [Stack Overflow "Error converting data type nvarchar to numeric"](https://stackoverflow.com/questions/53992339/)

## å†ç¾ã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…

ã“ã®å•é¡Œã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã€ç°¡æ˜“çš„ãªå†ç¾ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ãŸã€‚

### ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

```php
Schema::create('test_table', function (Blueprint $table) {
    $table->uuid('id')->primary();
    $table->string('name');
    $table->decimal('value', 5, 2); // DECIMAL(5,2) ã‚«ãƒ©ãƒ 
    $table->timestamps();
});
```

### Eloquent ãƒ¢ãƒ‡ãƒ«

```php
class TestModel extends Model
{
    use HasUuids;

    protected $table = 'test_table';

    protected $fillable = ['name', 'value'];

    protected $casts = [
        'value' => 'float',
    ];
}
```

### ã‚¨ãƒ©ãƒ¼å†ç¾ã‚³ãƒ¼ãƒ‰

```php
public function reproduceBug()
{
    DB::table('test_table')->truncate();

    // å‹ãŒæ··åœ¨ã—ãŸãƒ‡ãƒ¼ã‚¿
    $testData = [
        ['name' => 'Test 1', 'value' => 7.75],  // doubleå‹
        ['name' => 'Test 2', 'value' => 5],     // integerå‹ â† å•é¡Œã®åŸå› 
        ['name' => 'Test 3', 'value' => 6.5],   // doubleå‹
    ];

    $dataToInsert = array_map(
        fn ($data) => [
            'id' => (string) Str::uuid(),
            'name' => $data['name'],
            'value' => $data['value'], // å‹ãŒæ··åœ¨
            'created_at' => now(),
            'updated_at' => now(),
        ],
        $testData
    );

    // SQL Serverã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
    DB::table('test_table')->insert($dataToInsert);
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ SQL Server ç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹ã¨ã€æœŸå¾…é€šã‚Šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚

## è§£æ±ºç­–

### â‘  æ˜ç¤ºçš„ãªå‹ã‚­ãƒ£ã‚¹ãƒˆï¼ˆæ¨å¥¨ï¼‰

æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§åŠ¹æœçš„ãªè§£æ±ºç­–ã¯ã€ã™ã¹ã¦ã®å€¤ã‚’æ˜ç¤ºçš„ã«`float`å‹ã«ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹ã“ã¨ã§ã‚ã‚‹ã€‚

```php
$dataToInsert = array_map(
    fn ($data) => [
        'id' => (string) Str::uuid(),
        'name' => $data['name'],
        'value' => (float) $data['value'], // æ˜ç¤ºçš„ã«floatã«ã‚­ãƒ£ã‚¹ãƒˆ
        'created_at' => now(),
        'updated_at' => now(),
    ],
    $testData
);

DB::table('test_table')->insert($dataToInsert);
```

**ãƒ¡ãƒªãƒƒãƒˆ**

- ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„
- ãƒãƒ«ã‚¯ã‚¤ãƒ³ã‚µãƒ¼ãƒˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¶­æŒ
- 1 è¡Œã®å¤‰æ›´ã§è§£æ±º

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**

- ã™ã¹ã¦ã® insert ç®‡æ‰€ã§æ˜ç¤ºçš„ã«ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹

### â‘¡ Eloquent ã®`create()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨

Eloquent ã®`create()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚Œã°ã€ãƒ¢ãƒ‡ãƒ«ã§å®šç¾©ã—ãŸã‚­ãƒ£ã‚¹ãƒˆãŒè‡ªå‹•çš„ã«é©ç”¨ã•ã‚Œã‚‹ã€‚

```php
foreach ($testData as $data) {
    TestModel::create($data);
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**

- Eloquent ã®ã‚­ãƒ£ã‚¹ãƒˆãŒè‡ªå‹•é©ç”¨ã•ã‚Œã‚‹
- ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆcreating, created ç­‰ï¼‰ãŒç™ºç«ã™ã‚‹
- ã‚ˆã‚Šã€ŒEloquent çš„ã€ãªæ›¸ãæ–¹

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**

- ãƒãƒ«ã‚¯ã‚¤ãƒ³ã‚µãƒ¼ãƒˆã¨æ¯”è¼ƒã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®æŒ¿å…¥ã«ã¯ä¸å‘ã

å°è¦æ¨¡ãªãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚Œã°å·®ã¯å°ã•ã„ãŒã€æ•°ç™¾ä»¶ãƒ»æ•°åƒä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†å ´åˆã¯ã€`insert()`+æ˜ç¤ºçš„ã‚­ãƒ£ã‚¹ãƒˆã®æ–¹ãŒæœ‰åˆ©ã§ã‚ã‚‹ã€‚

### å®Ÿè£…æ™‚ã®æ¨å¥¨äº‹é …

ç§ã®æ„è¦‹ã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®æ–¹é‡ã‚’æ¨å¥¨ã™ã‚‹ã€‚

1. **ãƒãƒ«ã‚¯ã‚¤ãƒ³ã‚µãƒ¼ãƒˆæ™‚ã¯è§£æ±ºç­–â‘ ã‚’æ¡ç”¨**

   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒé‡è¦ãªå ´é¢ã§ã¯`insert()`+æ˜ç¤ºçš„ã‚­ãƒ£ã‚¹ãƒˆ
   - ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã«å‹ã‚­ãƒ£ã‚¹ãƒˆã®æ¼ã‚Œã‚’ãƒã‚§ãƒƒã‚¯

2. **å˜ä¸€ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆæ™‚ã¯è§£æ±ºç­–â‘¡ã‚’æ¡ç”¨**

   - 1 ä»¶ãšã¤ã®ä½œæˆã§ã‚ã‚Œã°`create()`ã‚’ä½¿ç”¨
   - Eloquent ã®æ©Ÿèƒ½ã‚’æœ€å¤§é™æ´»ç”¨

## å­¦ã‚“ã ã“ã¨

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã”ã¨ã®ç‰¹æ€§ã‚’ç†è§£ã™ã‚‹é‡è¦æ€§

MySQL ã‚„ PostgreSQL ã§ã¯å•é¡Œãªãå‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã€SQL Server ã§ã¯å‹•ä½œã—ãªã„å ´åˆãŒã‚ã‚‹ã€‚ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œã‚’è€ƒãˆã‚‹å ´åˆã€å„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å‹ã‚·ã‚¹ãƒ†ãƒ ã®é•ã„ã‚’ç†è§£ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

### PDO ã®å‹æ¨è«–ã«é ¼ã‚Šã™ããªã„

PDO ã¯ä¾¿åˆ©ã ãŒã€è‡ªå‹•å‹æ¨è«–ã«é ¼ã‚Šã™ãã‚‹ã¨äºˆæœŸã—ãªã„å‹•ä½œã«ã¤ãªãŒã‚‹ã€‚é‡è¦ãªãƒ‡ãƒ¼ã‚¿æ“ä½œã§ã¯ã€æ˜ç¤ºçš„ãªå‹æŒ‡å®šã‚’è¡Œã†ã¹ãã§ã‚ã‚‹ã€‚

## ã¾ã¨ã‚

Laravel ã¨ SQL Server ã®çµ„ã¿åˆã‚ã›ã§ DECIMAL å‹ã‚’æ‰±ã†éš›ã¯ã€PHP ã®å‹ã®æ··åœ¨ã«æ³¨æ„ãŒå¿…è¦ã§ã‚ã‚‹ã€‚ç‰¹ã«`DB::table()->insert()`ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€Eloquent ã®ã‚­ãƒ£ã‚¹ãƒˆãŒãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹ãŸã‚ã€æ˜ç¤ºçš„ãªå‹ã‚­ãƒ£ã‚¹ãƒˆãŒä¸å¯æ¬ ã§ã‚ã‚‹ã€‚

åŒæ§˜ã®å•é¡Œã«é­é‡ã—ãŸéš›ã¯ã€æœ¬è¨˜äº‹ã§ç´¹ä»‹ã—ãŸè§£æ±ºç­–ã‚’å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã‚ã‚‹ã€‚

## å‚è€ƒæ–‡çŒ®

- [Laravel Framework Issue #28923: "MSSQL conversion error"](https://github.com/laravel/framework/issues/28923)
- [Microsoft SQL Server Documentation: "Data Type Precedence (Transact-SQL)"](https://learn.microsoft.com/en-us/sql/t-sql/data-types/data-type-precedence-transact-sql)
- [Stack Overflow: "Error converting data type nvarchar to numeric when trying to create a record using Eloquent"](https://stackoverflow.com/questions/53992339/)
- [PHP Manual: "PDO::prepare"](https://www.php.net/manual/en/pdo.prepare.php)
