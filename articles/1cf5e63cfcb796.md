---
title: "Azure Easy Authç’°å¢ƒã§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã«502ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹åŸå› ã¨è§£æ±ºç­–"
emoji: "ğŸ¦Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["azure", "laravel", "php"]
published: false
---

## ç™ºç”Ÿã—ãŸå•é¡Œ

Azure App Serviceã§Easy Authï¼ˆAzure ADèªè¨¼ï¼‰ã‚’æœ‰åŠ¹ã«ã—ãŸç’°å¢ƒã«ãŠã„ã¦ã€PDFã‚„Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã§HTTP 502ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã€‚

```
ã“ã®ãƒšãƒ¼ã‚¸ã¯å‹•ä½œã—ã¦ã„ã¾ã›ã‚“
example.com ã§ã¯ç¾åœ¨ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ãã¾ã›ã‚“ã€‚
HTTP ERROR 502
```

ä¸æ€è­°ãªã“ã¨ã«ã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯æ­£å¸¸ã«å‹•ä½œã™ã‚‹ãŒã€Azureä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨å‹•ã‹ãªã„ã€‚Easy Authã‚’æœ‰åŠ¹ã«ã—ã¦ã‹ã‚‰ç™ºç”Ÿã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

## ç’°å¢ƒ

- Azure App Serviceï¼ˆLinuxï¼‰
- Azure Easy Authï¼ˆAzure ADèªè¨¼ï¼‰æœ‰åŠ¹
- Laravel ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- TCPDF/FPDI ã«ã‚ˆã‚‹PDFç”Ÿæˆã€PhpSpreadsheetã«ã‚ˆã‚‹Excelç”Ÿæˆ

## åŸå› 

Azure Easy Authã¯ã€ã™ã¹ã¦ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä»²ä»‹ã™ã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã—ã¦å‹•ä½œã™ã‚‹ã€‚[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/en-us/azure/app-service/overview-authentication-authorization)ã«ã‚ˆã‚‹ã¨ã€Linuxç’°å¢ƒã§ã¯å°‚ç”¨ã‚³ãƒ³ãƒ†ãƒŠã§ç‹¬ç«‹ã—ã¦å®Ÿè¡Œã•ã‚Œã€Ambassadorãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—ã¦å—ä¿¡ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¨ç›¸äº’ä½œç”¨ã™ã‚‹ã€‚ã“ã®æ§‹æˆã«ãŠã„ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ãŒç™ºç”Ÿã™ã‚‹å ´åˆãŒã‚ã‚‹ã€‚

### é€šå¸¸ã®é€šä¿¡ãƒ•ãƒ­ãƒ¼

Easy AuthãŒç„¡åŠ¹ãªå ´åˆã€ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã‚¢ãƒ—ãƒªãŒç›´æ¥é€šä¿¡ã™ã‚‹ã€‚

```mermaid
sequenceDiagram
    participant Browser as ãƒ–ãƒ©ã‚¦ã‚¶
    participant App as ã‚¢ãƒ—ãƒªï¼ˆPHPï¼‰
    Browser->>App: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰è¦æ±‚
    App->>Browser: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”å´
```

### Easy Authæœ‰åŠ¹æ™‚ã®é€šä¿¡ãƒ•ãƒ­ãƒ¼

Easy AuthãŒæœ‰åŠ¹ãªå ´åˆã€é€šä¿¡ãŒé–“ã«å…¥ã‚‹ã€‚

```mermaid
sequenceDiagram
    participant Browser as ãƒ–ãƒ©ã‚¦ã‚¶
    participant EasyAuth as Easy Auth
    participant App as ã‚¢ãƒ—ãƒªï¼ˆPHPï¼‰
    Browser->>EasyAuth: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰è¦æ±‚
    EasyAuth->>App: èªè¨¼æ¸ˆã¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆè»¢é€
    App->>EasyAuth: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”å´ï¼ˆã“ã“ã§è©°ã¾ã‚‹ï¼‰
    EasyAuth->>Browser: 502 Bad Gateway
```

### ãªãœã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã‹

å•é¡Œã®ã‚ã£ãŸã‚³ãƒ¼ãƒ‰ã¯StreamedResponseã‚„ãƒã‚¤ãƒŠãƒªã‚’ç›´æ¥è¿”ã™æ–¹å¼ã‚’ä½¿ç”¨ã—ã¦ã„ãŸã€‚

```php
// PDFã®å ´åˆï¼šãƒã‚¤ãƒŠãƒªã‚’ç›´æ¥ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã™
$pdfBinary = $pdfExportRepository();

return response($pdfBinary)
    ->header('Content-Type', 'application/pdf')
    ->header('Content-Disposition', 'attachment; filename="' . $filename . '"');
```

```php
// Excelã®å ´åˆï¼šStreamedResponseã§å°‘ã—ãšã¤é€ã‚‹
return new StreamedResponse(function () use ($writer) {
    $writer->save('php://output');
});
```

ã“ã‚Œã‚‰ã®æ–¹å¼ã§ã¯ã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã€‚

1. Easy Authã¯å…¨ãƒ‡ãƒ¼ã‚¿ãŒå±Šã„ã¦ã‹ã‚‰è»¢é€ã—ã‚ˆã†ã¨ã™ã‚‹ï¼ˆãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ï¼‰
2. ã‚¢ãƒ—ãƒªã¯å°‘ã—ãšã¤ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚Šç¶šã‘ã‚‹ã€ã¾ãŸã¯ãƒã‚¤ãƒŠãƒªã‚’ç›´æ¥é€ä¿¡ã™ã‚‹
3. Easy AuthãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹
4. 502ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

æ‰‹ç´™ã‚’1æšãšã¤æ¸¡ãã†ã¨ã—ã¦ã„ã‚‹ã®ã«ã€å—ã‘å–ã‚‹å´ãŒã€Œå…¨éƒ¨æƒã£ã¦ã‹ã‚‰å—ã‘å–ã‚Šã¾ã™ã€ã¨è¨€ã£ã¦ã„ã‚‹ã‚ˆã†ãªçŠ¶æ…‹ã§ã‚ã‚‹ã€‚

## è§£æ±ºç­–

ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã¦ã‹ã‚‰`response()->download()`ã§é€ä¿¡ã™ã‚‹æ–¹å¼ã«å¤‰æ›´ã™ã‚‹ã€‚

### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ï¼ˆPDFï¼‰

```php
// PDFã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
$pdfBinary = $pdfExportRepository();

// ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
$tempFile = tempnam(sys_get_temp_dir(), 'pdf_');
file_put_contents($tempFile, $pdfBinary);

// ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
$filename = sprintf(
    'document_%s.pdf',
    now()->format('Y-m-d_H-i-s')
);

return response()->download($tempFile, $filename, [
    'Content-Type' => 'application/pdf',
])->deleteFileAfterSend(true);
```

### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ï¼ˆExcelï¼‰

```php
// ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
$tempFile = tempnam(sys_get_temp_dir(), 'export_');

// ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
$writer->save($tempFile);

return response()->download($tempFile, $filename)
    ->deleteFileAfterSend(true);
```

### ãªãœè§£æ±ºã§ãã‚‹ã®ã‹

1. `response()->download()`ã¯Symfonyã®`BinaryFileResponse`ã‚’ä½¿ç”¨ã™ã‚‹
2. `BinaryFileResponse`ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ç›´æ¥ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§é€ä¿¡ã™ã‚‹
3. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒç¢ºå®šã—ã¦ã„ã‚‹ãŸã‚ã€Easy Authã‚‚æ­£ã—ãå‡¦ç†ã§ãã‚‹
4. `deleteFileAfterSend(true)`ã«ã‚ˆã‚Šã€é€ä¿¡å®Œäº†å¾Œã«ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹

```mermaid
sequenceDiagram
    participant Browser as ãƒ–ãƒ©ã‚¦ã‚¶
    participant EasyAuth as Easy Auth
    participant App as ã‚¢ãƒ—ãƒªï¼ˆPHPï¼‰
    Browser->>EasyAuth: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰è¦æ±‚
    EasyAuth->>App: èªè¨¼æ¸ˆã¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆè»¢é€
    Note over App: ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
    App->>EasyAuth: å®Œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚µã‚¤ã‚ºç¢ºå®šï¼‰
    EasyAuth->>Browser: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”å´
    Note over App: ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
```

## StreamedResponseãŒæœ‰åŠ¹ãªã‚±ãƒ¼ã‚¹ã¨é¿ã‘ã‚‹ã¹ãã‚±ãƒ¼ã‚¹

### æœ‰åŠ¹ãªã‚±ãƒ¼ã‚¹

StreamedResponseã¯ã€Œãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ãªãŒã‚‰ã€ã§ããŸéƒ¨åˆ†ã‹ã‚‰é †æ¬¡é€ä¿¡ã™ã‚‹ã€æ–¹å¼ã§ã‚ã‚‹ã€‚ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã§æœ‰åŠ¹ã€‚

- å·¨å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆæ•°GBã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã€å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿é…ä¿¡ï¼ˆãƒãƒ£ãƒƒãƒˆã€æ ªä¾¡ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰
- å‹•ç”»ãƒ»éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
- ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆSSEï¼‰

### é¿ã‘ã‚‹ã¹ãã‚±ãƒ¼ã‚¹

- ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã®ç’°å¢ƒï¼ˆä»Šå›ã®å•é¡Œã®ã‚ˆã†ã«ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã¨ç«¶åˆã™ã‚‹ï¼‰
- å°ã€œä¸­è¦æ¨¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆãŒãªã„ï¼‰
- Content-LengthãŒå¿…è¦ãªå ´åˆï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒäº‹å‰ã«åˆ†ã‹ã‚‰ãªã„ï¼‰

ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿é‡ãŒæ•°ç™¾ã€œæ•°åƒä»¶ç¨‹åº¦ã§ã‚ã‚Šã€StreamedResponseã®ãƒ¡ãƒªãƒƒãƒˆãŒãªãã€BinaryFileResponseãŒé©åˆ‡ã§ã‚ã£ãŸã€‚

## ã¾ã¨ã‚

Azure Easy Authç’°å¢ƒã§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã«502ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆã€StreamedResponseã‚„ãƒã‚¤ãƒŠãƒªç›´æ¥è¿”å´ã§ã¯ãªãã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ã®`response()->download()`ã‚’ä½¿ç”¨ã™ã‚‹ã€‚ã“ã®æ–¹å¼ã¯Easy Authã®ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°å‡¦ç†ã¨äº’æ›æ€§ãŒã‚ã‚Šã€å•é¡Œã‚’è§£æ±ºã§ãã‚‹ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯å‹•ä½œã™ã‚‹ãŒAzureç’°å¢ƒã§å‹•ä½œã—ãªã„å ´åˆã€Easy Authã®ãƒ—ãƒ­ã‚­ã‚·å‡¦ç†ã¨ã®ç›¸æ€§ã‚’ç–‘ã†ã¨ã‚ˆã„ã€‚

## å‚è€ƒ

- [Authentication and Authorization - Azure App Service | Microsoft Learn](https://learn.microsoft.com/en-us/azure/app-service/overview-authentication-authorization)
- [Issues with Streaming File Response from Azure App Service - Microsoft Q&A](https://learn.microsoft.com/en-us/answers/questions/2150156/issues-with-streaming-file-response-from-azure-app)
- [File Downloads - Laravel Documentation](https://laravel.com/docs/responses#file-downloads)
