---
title: "Laravelã«ãŠã‘ã‚‹æ¨©é™ç®¡ç†ã®ãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹"
emoji: "ðŸ¦Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["php", "laravel"]
published: true
---

## å‰æ›¸ã

ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ã«ã‚ãŸã£ã¦ã€æ¨©é™ç®¡ç†ã¯ã»ã¨ã‚“ã©ã®ã‚±ãƒ¼ã‚¹ã«ãŠã„ã¦å¿…é ˆã¨ãªã£ã¦ãã‚‹ã“ã¨ãŒå¤šã„ã€‚
æŽ²ç¤ºæ¿ã‚µã‚¤ãƒˆ1ã¤ã‚’ä¾‹ã«ã¨ã£ã¦ã‚‚ã€æŠ•ç¨¿ã‚’ç·¨é›†ã€å‰Šé™¤ã€æŠ•ç¨¿ã«å¯¾ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã§ãã‚‹ãªã©æ§˜ã€…ãªã‚±ãƒ¼ã‚¹ã«ãŠã„ã¦ã€æ¤œè¨Žã™ã¹ãã‚±ãƒ¼ã‚¹ãŒå¤šã„ã€‚

ã¾ãŸã€æ¨©é™ã®ãƒ«ãƒ¼ãƒ«ã‚‚è¤‡é›‘ã«ãªã£ã¦ãã‚‹ã“ã¨ãŒå¤šã„ã€‚
ä¾‹ãˆã°ã€æŠ•ç¨¿ã‹ã‚‰1æ—¥ä»¥å†…ã§ã‚ã‚Œã°å‰Šé™¤ã§ãã‚‹ã€‚ç®¡ç†è€…ã§ã‚ã‚Œã°å‰Šé™¤ã§ãã‚‹ã€æ‰€å±žã—ã¦ã„ã‚‹äº‹æ¥­æ‰€ãŒåŒã˜ã§ã‚ã‚Œã°ã€å‰Šé™¤ã§ãã‚‹ã€‚æ‰€å±žãŒåŒã˜ã‹ã¤ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã‚ã‚Œã°ã€ãªã©æ§˜ã€…ãªã‚·ãƒŠãƒªã‚ªãŒã‚ã‚‹ã€‚

ãã†ã„ã£ãŸå ´åˆã®Laravelã§ã¯ã€ã©ã®ã‚ˆã†ãªãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã§è§£æ¶ˆã§ãã‚‹ã‹ã‚’ã“ã®è¨˜äº‹ã§ã¯èª¬æ˜Žã™ã‚‹ã€‚
## ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®åŸºæœ¬æ¦‚å¿µ

æ¨©é™ã®è©±é¡Œã‚’ã™ã‚‹ã¨ä¸ŠãŒã£ã¦ãã‚‹ã®ãŒã€RBAC(Role Base Access Control)ã¨ABAC(Attribute Base Access Control)ã€PBAC(Policy Base Access Control)ã®ä¸»ãª3ã¤ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã§ã‚ã‚‹ã€‚ãã®ä»–ã«ã‚‚ã•ã¾ã–ã¾ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®è€ƒãˆãŒã‚ã‚‹ã¨æ€ã†ãŒã€ã“ã“ã§ã¯çœç•¥ã™ã‚‹ã€‚

### RBACï¼ˆRole-Based Access Controlï¼‰

RBACã¨ã¯ã€ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã§ã‚ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å½¹å‰²ï¼ˆãƒ­ãƒ¼ãƒ«ï¼‰ã‚’å‰²ã‚Šå½“ã¦ã€ãã®ãƒ­ãƒ¼ãƒ«ã«å¯¾ã—ã¦æ¨©é™ï¼ˆpermissionï¼‰ã‚’ä»˜ä¸Žã™ã‚‹ã“ã¨ã§æ¨©é™ç®¡ç†ã‚’è¡Œã†ä»•çµ„ã¿ã§ã‚ã‚‹ã€‚

æ¯”è¼ƒçš„ã‚·ãƒ³ãƒ—ãƒ«ãªæ¨©é™ç®¡ç†ã‚’è¡Œã†å ´åˆã«ã‚ãŸã£ã¦ã€ã¨ã¦ã‚‚æœ‰åŠ¹ã§ã‚ã‚‹ã€‚ãƒ­ãƒ¼ãƒ«ã«ä»˜ä¸Žã•ã‚Œã¦ã„ã‚‹æ¨©é™ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€å½±éŸ¿ã™ã‚‹ç®‡æ‰€ã®ä¿®æ­£ã‚³ã‚¹ãƒˆãŒæ¸›ã‚‹ã€‚ãŸã ã—ã€è¤‡é›‘ãªæ¡ä»¶ã«ãŠã‘ã‚‹æ¨©é™ç®¡ç†ã«ã¯é©ã•ãªã„ã€‚

RBACã®åˆ©ç‚¹ã¯çµ„ç¹”æ§‹é€ ã«åˆã‚ã›ãŸæ¨©é™è¨­è¨ˆãŒå¯èƒ½ã§ã‚ã‚‹ç‚¹ã ã€‚
å¾“æ¥ã®ã€Œç®¡ç†è€…ã€ã€Œä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã¨ã„ã£ãŸå˜ç´”ãªåŒºåˆ†ã‹ã‚‰è„±å´ã—ã€ã€Œãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€ã€Œç·¨é›†è€…ã€ã€Œé–²è¦§è€…ã€ãªã©ã€ã‚ˆã‚Šç¾å®Ÿçš„ãªå½¹å‰²åˆ†æ‹…ã‚’åæ˜ ã§ãã‚‹ã€‚

### ABACï¼ˆAttribute-Based Access Controlï¼‰

ABACã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±žæ€§ã«å¿œã˜ãŸã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã§ã‚ã‚‹ã€‚æ‰€å±žéƒ¨ç½²ãŒåŒã˜ã§ã‚ã‚Œã°ã€æ“ä½œã§ãã‚‹ã¨ã„ã£ãŸåˆ¶å¾¡ã‚’æŒ‡ã™ã€‚
ã“ã¡ã‚‰ã¯è¤‡é›‘ãªæ¨©é™ç®¡ç†ã«å¯¾å¿œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ãŸã ã—ã€æ¨©é™ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚³ã‚¹ãƒˆãŒå¤§ãã„ãŸã‚ã€æŽ¡ç”¨ã™ã‚‹éš›ã¯ã‚ˆãæ¤œè¨Žã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ABACã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±žæ€§ï¼ˆéƒ¨ç½²ã€å½¹è·ã€çµŒé¨“å¹´æ•°ï¼‰ã€ãƒªã‚½ãƒ¼ã‚¹ã®å±žæ€§ï¼ˆä½œæˆè€…ã€éƒ¨ç½²ã€æ©Ÿå¯†ãƒ¬ãƒ™ãƒ«ï¼‰ã€ç’°å¢ƒã®å±žæ€§ï¼ˆæ™‚é–“ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‡ãƒã‚¤ã‚¹ï¼‰ãªã©ã€å¤šæ§˜ãªè¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã¦æ¨©é™åˆ¤å®šã‚’è¡Œã†ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€ŒåŒã˜éƒ¨ç½²ã®ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã¿ç·¨é›†å¯èƒ½ã€ã¨ã„ã£ãŸæŸ”è»Ÿãªãƒ«ãƒ¼ãƒ«ã‚’å®Ÿç¾ã§ãã‚‹ã€‚

### PBACï¼ˆPolicy-Based Access Controlï¼‰

PBACã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã‚„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªã‚·ãƒ¼ã«å¿œã˜ãŸã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã§ã‚ã‚‹ã€‚
ä¾‹ãˆã°ã€æŠ•ç¨¿ã¯1æ—¥ä»¥å†…ã§ã‚ã‚Œã°å‰Šé™¤ã§ãã‚‹ã€å¤œé–“ã¯æ“ä½œã§ããªã„ã¨ã„ã£ãŸã‚±ãƒ¼ã‚¹ã«é©åˆã™ã‚‹ã€‚

PBACã¯æ™‚é–“ã‚„çŠ¶æ³ã«ä¾å­˜ã™ã‚‹æ¨©é™ç®¡ç†ã«ç‰¹åŒ–ã—ã¦ã„ã‚‹ã€‚ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚„ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¦ä»¶ã‚’ç›´æŽ¥ã‚³ãƒ¼ãƒ‰ã«åæ˜ ã§ãã€å‹•çš„ãªæ¨©é™åˆ¶å¾¡ã‚’å®Ÿç¾ã™ã‚‹ã€‚

---

ã“ã“ã§å„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã«ã¤ã„ã¦è§£èª¬ã—ãŸãŒã€é‡è¦ãªã®ã¯å˜ä¸€ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡æ–¹å¼ã«å›ºåŸ·ã™ã‚‹ã®ã§ã¯ãªãã€è¦ä»¶ã«å¿œã˜ã¦é©åˆ‡ãªåˆ¶å¾¡æ–¹å¼ã‚’é¸æŠžã™ã‚‹ã“ã¨ã§ã‚ã‚‹ã€‚
å®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã§ã¯ã€RBACã¨PBACã‚’çµ„ã¿åˆã‚ã›ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’æŽ¡ç”¨ã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚
ä¾‹ãˆã°ã€AWSã®IAMãƒãƒªã‚·ãƒ¼ã‚‚ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®åˆ¶å¾¡ã¨å±žæ€§ãƒ™ãƒ¼ã‚¹ã®åˆ¶å¾¡ã‚’çµ„ã¿åˆã‚ã›ãŸä»•çµ„ã¿ã‚’æä¾›ã—ã¦ã„ã‚‹ã€‚
ã“ã®ã‚ˆã†ã«ã€è¤‡æ•°ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡æ–¹å¼ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€æŸ”è»Ÿã‹ã¤åŠ¹æžœçš„ãªæ¨©é™ç®¡ç†ã‚’å®Ÿç¾ã§ãã‚‹ã€‚

## Laravelã«ãŠã‘ã‚‹æ¨©é™ç®¡ç†ã®é¸æŠžè‚¢

Laravelã§ã¯æ¨©é™ç®¡ç†ã«å¯¾ã—ã¦è¤‡æ•°ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚æ¨™æº–æ©Ÿèƒ½ã§ã‚ã‚‹Gateã¨Policyã€ãã—ã¦å¤–éƒ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚ã‚‹Laravel PermissionãŒä¸»è¦ãªé¸æŠžè‚¢ã§ã‚ã‚‹ã€‚

### Gate/Policy

#### Gate

Gateã¯ã€LaravelãŒæä¾›ã™ã‚‹æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªæ¨©é™ç®¡ç†æ©Ÿèƒ½ã§ã‚ã‚‹ã€‚ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ™ãƒ¼ã‚¹ã§æ¨©é™ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®šç¾©ã—ã€ä¸»ã«ABACã‚„PBACã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«é©ã—ã¦ã„ã‚‹ã€‚

```php
// AuthServiceProvider.php
Gate::define('edit-post', function ($user, $post) {
    // ä½œæˆè€…æœ¬äººã‹ã€åŒã˜éƒ¨ç½²ã®ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä»¥ä¸Š
    return $user->id === $post->user_id || 
           ($user->department === $post->author->department && 
            in_array($user->role, ['manager', 'director'], true));
});

Gate::define('delete-post', function ($user, $post) {
    // 1æ—¥ä»¥å†…ã‹ã¤ä½œæˆè€…æœ¬äººã€ã¾ãŸã¯ç®¡ç†è€…
    return ($post->created_at->diffInDays() <= 1 && $user->id === $post->user_id) ||
           $user->hasRole('admin');
});
```

Gateã®åˆ©ç‚¹ã¯ã€è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç›´æŽ¥è¨˜è¿°ã§ãã‚‹ã“ã¨ã§ã‚ã‚‹ã€‚æ™‚é–“çš„åˆ¶ç´„ã€å±žæ€§æ¯”è¼ƒã€å¤–éƒ¨APIã¨ã®é€£æºãªã©ã€ã‚ã‚‰ã‚†ã‚‹æ¡ä»¶ã‚’çµ„ã¿è¾¼ã‚ã‚‹ã€‚
åé¢ã€æ¨©é™ãŒå¢—åŠ ã™ã‚‹ã¨ç®¡ç†ãŒå›°é›£ã«ãªã‚Šã€ãƒ†ã‚¹ãƒˆã‚‚è¤‡é›‘åŒ–ã™ã‚‹å‚¾å‘ãŒã‚ã‚‹ã€‚

#### Policy

Policyã¯Eloquentãƒ¢ãƒ‡ãƒ«ã«ç‰¹åŒ–ã—ãŸæ¨©é™ç®¡ç†æ©Ÿèƒ½ã§ã‚ã‚‹ã€‚
RESTfulãªæ“ä½œï¼ˆ`view`ã€`create`ã€`update`ã€`delete`ï¼‰ã«å¯¾å¿œã—ãŸæ§‹é€ åŒ–ã•ã‚ŒãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æä¾›ã™ã‚‹ã€‚

```php
// PostPolicy.php
class PostPolicy
{
    public function view(User $user, Post $post)
    {
        // å…¬é–‹æ¸ˆã¿ã‹ã€ä½œæˆè€…æœ¬äººã‹ã€åŒéƒ¨ç½²ã®å½¹å“¡
        return $post->status === 'published' ||
               $user->id === $post->user_id ||
               ($user->department === $post->author->department && $user->role === 'director');
    }

    public function update(User $user, Post $post)
    {
        return $user->id === $post->user_id ||
               ($user->department === $post->author->department && 
                in_array($user->role, ['manager', 'director']));
    }

    public function delete(User $user, Post $post)
    {
        return $user->hasRole('admin') ||
               ($user->id === $post->user_id && $post->created_at->diffInDays() <= 1);
    }
}
```

Policyã®å¼·ã¿ã¯ã€ãƒ¢ãƒ‡ãƒ«ä¸­å¿ƒã®æ•´ç†ã•ã‚ŒãŸæ§‹é€ ã§ã‚ã‚‹ã€‚å„ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã™ã‚‹æ¨©é™ãƒ­ã‚¸ãƒƒã‚¯ãŒæ˜Žç¢ºã«åˆ†é›¢ã•ã‚Œã€å¯èª­æ€§ã¨ä¿å®ˆæ€§ãŒå‘ä¸Šã™ã‚‹ã€‚

### Laravel Permission

Laravel Permissionã¯ã€Spatieç¤¾ãŒé–‹ç™ºã—ãŸRBACå®Ÿè£…ã«ç‰¹åŒ–ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚ã‚‹ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ã®æ¨©é™ç®¡ç†ã‚’æä¾›ã—ã€ãƒ­ãƒ¼ãƒ«ã¨æ¨©é™ã®éšŽå±¤æ§‹é€ ã‚’åŠ¹çŽ‡çš„ã«ç®¡ç†ã§ãã‚‹ã€‚

```php
// ãƒ­ãƒ¼ãƒ«ã¨æ¨©é™ã®å®šç¾©
$role = Role::create(['name' => 'marketing-manager']);
$permission = Permission::create(['name' => 'edit posts']);

$role->givePermissionTo($permission);
$user->assignRole('marketing-manager');

// æ¨©é™ãƒã‚§ãƒƒã‚¯
if ($user->can('edit posts')) {
    // ç·¨é›†æ¨©é™ã‚ã‚Š
}

if ($user->hasRole('marketing-manager')) {
    // ãƒžãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®æ¨©é™ã‚ã‚Š
}
```

### Gate/Policyã¨ã®é•ã„

Laravel Permissionã¨Gate/Policyã®æœ€å¤§ã®é•ã„ã¯ã€æ¨©é™ç®¡ç†ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã‚ã‚‹ã€‚

**ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã®è¦³ç‚¹**
- Gate/Policyï¼šã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§æ¨©é™ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç®¡ç†
- Laravel Permissionï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ã§æ¨©é™æƒ…å ±ã‚’ç®¡ç†

**æŸ”è»Ÿæ€§ã®è¦³ç‚¹**
- Gate/Policyï¼šè¤‡é›‘ãªæ¡ä»¶åˆ†å²ã‚„ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã«å¯¾å¿œ
- Laravel Permissionï¼šãƒ­ãƒ¼ãƒ«ã¨æ¨©é™ã®çµ„ã¿åˆã‚ã›ã«ç‰¹åŒ–

**é‹ç”¨ã®è¦³ç‚¹**
- Gate/Policyï¼šæ¨©é™å¤‰æ›´æ™‚ã«ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦
- Laravel Permissionï¼šç®¡ç†ç”»é¢ã‹ã‚‰å‹•çš„ã«æ¨©é™å¤‰æ›´ãŒå¯èƒ½

ç§ã®çµŒé¨“ä¸Šã€å°è¦æ¨¡ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„è¤‡é›‘ãªæ¡ä»¶åˆ¤å®šãŒå¿…è¦ãªå ´åˆã¯Gate/PolicyãŒé©ã—ã¦ã„ã‚‹ã€‚ä¸€æ–¹ã€ä¸­è¦æ¨¡ä»¥ä¸Šã§çµ„ç¹”çš„ãªæ¨©é™ç®¡ç†ãŒå¿…è¦ãªå ´åˆã¯ã€Laravel Permissionã®æ–¹ãŒé‹ç”¨åŠ¹çŽ‡ãŒé«˜ã„ã€‚

### è‡ªå‰ã§å®Ÿè£…ã—ãªã„ç†ç”±

æ¨©é™ç®¡ç†ã‚’è‡ªå‰ã§å®Ÿè£…ã™ã‚‹ã“ã¨ã¯æŠ€è¡“çš„ã«ã¯å¯èƒ½ã ãŒã€ä»¥ä¸‹ã®ç†ç”±ã‹ã‚‰ç§ã¯Laravel Permissionã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯**
æ¨©é™ç®¡ç†ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¦ã§ã‚ã‚Šã€å®Ÿè£…ãƒŸã‚¹ãŒç›´æŽ¥çš„ãªè„†å¼±æ€§ã«ã¤ãªãŒã‚‹ã€‚æ—¢å­˜ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯å¤šãã®é–‹ç™ºè€…ã«ã‚ˆã£ã¦ãƒ†ã‚¹ãƒˆã•ã‚Œã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ›ãƒ¼ãƒ«ãŒä¿®æ­£ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå¤šã„ã€‚

**ä¿å®ˆæ€§ã®å•é¡Œ**
è‡ªå‰å®Ÿè£…ã®æ¨©é™ã‚·ã‚¹ãƒ†ãƒ ã¯ã€è¦ä»¶å¤‰æ›´ã‚„æ©Ÿèƒ½è¿½åŠ æ™‚ã®ä¿®æ­£ã‚³ã‚¹ãƒˆãŒé«˜ã„ã€‚ç‰¹ã«ã€æ¨©é™éšŽå±¤ã®å¤‰æ›´ã‚„æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡æ–¹å¼ã®å°Žå…¥æ™‚ã«å¤§å¹…ãªä¿®æ­£ãŒå¿…è¦ã«ãªã‚‹ã€‚

**ãƒ†ã‚¹ãƒˆã®è¤‡é›‘åŒ–**
æ¨©é™ç®¡ç†ã®ãƒ†ã‚¹ãƒˆã¯çµ„ã¿åˆã‚ã›ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè†¨å¤§ã«ãªã‚Šã€è‡ªå‰å®Ÿè£…ã§ã¯æ¼ã‚ŒãŒç”Ÿã˜ã‚„ã™ã„ã€‚æ—¢å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã¯åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹ã€‚ã“ã‚Œã‚‰ã®ç†ç”±ã‹ã‚‰ã€ç‰¹åˆ¥ãªè¦ä»¶ãŒãªã„é™ã‚Šã¯ã€å®Ÿç¸¾ã®ã‚ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’é¸æŠžã™ã‚‹ã“ã¨ãŒè³¢æ˜Žã¨è€ƒãˆã‚‹ã€‚

## å…·ä½“çš„ãªã‚·ãƒŠãƒªã‚ª

å®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã§æ¨©é™ç®¡ç†ãŒã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã‚‹ã‹ã‚’ã€ä¼æ¥­ãƒ–ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¾‹ã«æ¯”è¼ƒæ¤œè¨Žã™ã‚‹ã€‚

### æƒ³å®šã•ã‚Œã‚‹è¦ä»¶

| é …ç›® | è©³ç´° |
|------|------|
| **çµ„ç¹”æ§‹é€ ** | |
| éƒ¨ç½² | ãƒžãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã€äººäº‹ |
| å½¹è·ãƒ¬ãƒ™ãƒ« | ä¸€èˆ¬ã€ä¸»ä»»ã€ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€å½¹å“¡ |
| è¨˜äº‹ã®çŠ¶æ…‹ | ä¸‹æ›¸ãã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã€å…¬é–‹æ¸ˆã¿ |
| **æ¨©é™ãƒ«ãƒ¼ãƒ«** | |
| è¨˜äº‹ä½œæˆ | å…¨ã¦ã®èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ |
| è¨˜äº‹ç·¨é›† | ä½œæˆè€…æœ¬äºº + åŒéƒ¨ç½²ã®ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä»¥ä¸Š |
| è¨˜äº‹å…¬é–‹ | ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä»¥ä¸Šã®ã¿ |
| ä»–éƒ¨ç½²è¨˜äº‹é–²è¦§ | å½¹å“¡ã®ã¿ |
| åˆ†æžãƒ‡ãƒ¼ã‚¿é–²è¦§ | ãƒžãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨ + å½¹å“¡ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† | äººäº‹éƒ¨ã®ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä»¥ä¸Š |

### Gate/Policyã§ã®å®Ÿè£…

```php
// AuthServiceProvider.php
Gate::define('create-article', function ($user) {
    return $user !== null; // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
});

Gate::define('edit-article', function ($user, $article) {
    // ä½œæˆè€…æœ¬äººã¾ãŸã¯åŒéƒ¨ç½²ã®ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä»¥ä¸Š
    return $user->id === $article->user_id || 
           ($user->department === $article->author->department && 
            in_array($user->role, ['manager', 'director']));
});

Gate::define('publish-article', function ($user) {
    return in_array($user->role, ['manager', 'director']);
});

Gate::define('view-other-department-articles', function ($user) {
    return $user->role === 'director';
});

Gate::define('view-analytics', function ($user) {
    return $user->department === 'marketing' || $user->role === 'director';
});

Gate::define('manage-users', function ($user) {
    return $user->department === 'hr' && 
           in_array($user->role, ['manager', 'director']);
});
```

**èª²é¡Œã¨å•é¡Œç‚¹**
1. é–¢é€£ã™ã‚‹æ¨©é™ãƒ«ãƒ¼ãƒ«ãŒè¤‡æ•°ã®Gateå®šç¾©ã«åˆ†æ•£ã—ã€å…¨ä½“åƒã®æŠŠæ¡ãŒå›°é›£
2. å½¹è·ãƒã‚§ãƒƒã‚¯ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒå„å®šç¾©ã§é‡è¤‡
3. å„Gateå®šç¾©ã«å¯¾ã™ã‚‹å€‹åˆ¥ãƒ†ã‚¹ãƒˆãŒå¿…è¦
4. æ–°ã—ã„éƒ¨ç½²ã‚„å½¹è·ã®è¿½åŠ æ™‚ã«ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãŒå¿…è¦

### Laravel Permissionã§ã®å®Ÿè£…

```php
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã®ãƒ­ãƒ¼ãƒ«ãƒ»æ¨©é™å®šç¾©
$departments = ['marketing', 'engineering', 'hr'];
$roles = ['staff', 'senior', 'manager', 'director'];

foreach ($departments as $dept) {
    foreach ($roles as $role) {
        Role::create(['name' => "{$dept}-{$role}"]);
    }
}

// æ¨©é™ã®å®šç¾©
$permissions = [
    'create articles',
    'edit own articles',
    'edit department articles',
    'publish articles',
    'view other department articles',
    'view analytics',
    'manage users'
];

foreach ($permissions as $permission) {
    Permission::create(['name' => $permission]);
}

// æ¨©é™ã®å‰²ã‚Šå½“ã¦
// å…¨å“¡ãŒè¨˜äº‹ä½œæˆå¯èƒ½
Role::all()->each(function ($role) {
    $role->givePermissionTo('create articles', 'edit own articles');
});

// ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä»¥ä¸Šã¯éƒ¨ç½²å†…è¨˜äº‹ç·¨é›†ãƒ»å…¬é–‹å¯èƒ½
Role::where('name', 'like', '%-manager')
    ->orWhere('name', 'like', '%-director')
    ->get()
    ->each(function ($role) {
        $role->givePermissionTo('edit department articles', 'publish articles');
    });

// å½¹å“¡ã¯ä»–éƒ¨ç½²è¨˜äº‹é–²è¦§å¯èƒ½
Role::where('name', 'like', '%-director')
    ->get()
    ->each(function ($role) {
        $role->givePermissionTo('view other department articles');
    });
```

**ä½¿ç”¨æ™‚ã®ã‚³ãƒ¼ãƒ‰**
```php
// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§ã®æ¨©é™ãƒã‚§ãƒƒã‚¯
public function edit(Article $article)
{
    if ($user->can('edit own articles') && $user->id === $article->user_id) {
        // æœ¬äººã®è¨˜äº‹ç·¨é›†
    } elseif ($user->can('edit department articles') && 
              $user->department === $article->author->department) {
        // éƒ¨ç½²å†…è¨˜äº‹ç·¨é›†
    } else {
        abort(403);
    }
}

public function index()
{
    $query = Article::query();
    
    if (!$user->can('view other department articles')) {
        $query->whereHas('author', function ($q) use ($user) {
            $q->where('department', $user->department);
        });
    }
    
    return $query->get();
}
```

### å®Ÿè£…æ¯”è¼ƒã«ã‚ˆã‚‹è€ƒå¯Ÿ

**ä¿å®ˆæ€§ã®è¦³ç‚¹**
Gate/Policyã§ã¯æ¨©é™å¤‰æ›´æ™‚ã«ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã¨ãƒ†ã‚¹ãƒˆãŒå¿…è¦ã«ãªã‚‹ã€‚ç‰¹ã«çµ„ç¹”å¤‰æ›´æ™‚ã®å½±éŸ¿ç¯„å›²ãŒåºƒã„ã€‚Laravel Permissionã§ã¯ç®¡ç†ç”»é¢ã‹ã‚‰æ¨©é™å¤‰æ›´ãŒå¯èƒ½ã§ã€é–‹ç™ºè€…ã®ä»‹å…¥ãªã—ã«é‹ç”¨ãƒãƒ¼ãƒ ãŒå¯¾å¿œã§ãã‚‹ã€‚

**æ‹¡å¼µæ€§ã®è¦³ç‚¹**
æ–°ã—ã„éƒ¨ç½²ã‚„å½¹è·ã®è¿½åŠ æ™‚ã€Gate/Policyã§ã¯å„æ¨©é™å®šç¾©ã®è¦‹ç›´ã—ãŒå¿…è¦ã§ã‚ã‚‹ã€‚Laravel Permissionã§ã¯æ–°ã—ã„ãƒ­ãƒ¼ãƒ«ã®ä½œæˆã¨æ—¢å­˜æ¨©é™ã®çµ„ã¿åˆã‚ã›ã§å¯¾å¿œã§ãã‚‹ã€‚

### Laravel Permissionã«ãŠã‘ã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
Laravel Permissionã‚’ä½¿ç”¨ã™ã‚‹éš›ã¯ã€Rolesã¨Permissionsã®é©åˆ‡ãªè¨­è¨ˆãŒé‡è¦ã§ã‚ã‚‹ã€‚å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ä»¥ä¸‹ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ãŒæŽ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã€‚

**æ¨©é™åã®è¨­è¨ˆåŽŸå‰‡**
æ¨©é™åã¯å¯èƒ½ãªé™ã‚Šè©³ç´°ã‹ã¤å…·ä½“çš„ã«å‘½åã™ã‚‹ã€‚`manage posts`ã§ã¯ãªã`create posts`ã€`edit posts`ã€`delete posts`ã®ã‚ˆã†ã«åˆ†å‰²ã™ã‚‹ã“ã¨ã§ã€ç´°ã‹ãªæ¨©é™åˆ¶å¾¡ãŒå¯èƒ½ã«ãªã‚‹ã€‚

**ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®æ¨©é™ç¶™æ‰¿**
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç›´æŽ¥æ¨©é™ã‚’ä»˜ä¸Žã›ãšã€å¿…ãšãƒ­ãƒ¼ãƒ«çµŒç”±ã§æ¨©é™ã‚’ç¶™æ‰¿ã•ã›ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šæ¨©é™ç®¡ç†ã®ä¸€è²«æ€§ãŒä¿ãŸã‚Œã€æ¨©é™ã®è¿½è·¡ã¨å¤‰æ›´ãŒå®¹æ˜“ã«ãªã‚‹ã€‚

**æ¨©é™ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…æ–¹é‡**
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§ã¯ã€ãƒ­ãƒ¼ãƒ«åã§ã¯ãªãæ¨©é™åã§æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€çµ„ç¹”å¤‰æ›´æ™‚ã§ã‚‚æ¨©é™ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£ãŒæœ€å°é™ã«æŠ‘ãˆã‚‰ã‚Œã‚‹ã€‚
[Roles vs Permissions](https://spatie.be/docs/laravel-permission/v6/best-practices/roles-vs-permissions)

### ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®ææ¡ˆ

å®Ÿéš›ã®é–‹ç™ºã§ã¯ã€ä¸¡ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®çµ„ã¿åˆã‚ã›ãŒåŠ¹æžœçš„ã§ã‚ã‚‹ã¨è€ƒãˆã‚‹ã€‚

```php
// Laravel Permissionã§ãƒ™ãƒ¼ã‚¹æ¨©é™ã‚’ç®¡ç†
if (!$user->hasRole('manager|director')) {
    abort(403);
}

// Gateã§è¤‡é›‘ãªæ¡ä»¶ã‚’åˆ¤å®š
Gate::define('edit-article-with-conditions', function ($user, $article) {
    // åŸºæœ¬æ¨©é™ã¯Laravel Permissionã§ç¢ºèªæ¸ˆã¿
    // ã“ã“ã§ã¯æ™‚é–“åˆ¶é™ãªã©è¤‡é›‘ãªæ¡ä»¶ã®ã¿åˆ¤å®š
    if ($article->status === 'published') {
        return $article->created_at->diffInHours() <= 24;
    }
    return true;
});
```

ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€çµ„ç¹”çš„ãªæ¨©é™ç®¡ç†ã®åŠ¹çŽ‡æ€§ã¨ã€è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¸ã®å¯¾å¿œåŠ›ã‚’ä¸¡ç«‹ã§ãã‚‹ã€‚

## ã¾ã¨ã‚

Laravelã«ãŠã‘ã‚‹æ¨©é™ç®¡ç†ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®è¦ä»¶ã¨é‹ç”¨ä½“åˆ¶ã«å¿œã˜ã¦é©åˆ‡ãªæ‰‹æ³•ã‚’é¸æŠžã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã‚ã‚‹ã€‚

**Gate/PolicyãŒé©ã—ã¦ã„ã‚‹å ´é¢**
- å°è¦æ¨¡ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- è¤‡é›‘ãªæ¡ä»¶åˆ¤å®šãŒä¸­å¿ƒã®æ¨©é™ç®¡ç†
- æ¨©é™å¤‰æ›´ãŒç¨€ã§ã€é–‹ç™ºãƒãƒ¼ãƒ ãŒç®¡ç†ã™ã‚‹å ´åˆ

**Laravel PermissionãŒé©ã—ã¦ã„ã‚‹å ´é¢**
- ä¸­è¦æ¨¡ä»¥ä¸Šã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- çµ„ç¹”æ§‹é€ ã«åŸºã¥ã„ãŸæ¨©é™ç®¡ç†
- é‹ç”¨ãƒãƒ¼ãƒ ãŒæ¨©é™ã‚’å‹•çš„ã«ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆ

ç§ã®çµŒé¨“ä¸Šã€å¤šãã®ä¼æ¥­ã‚·ã‚¹ãƒ†ãƒ ã§ã¯Laravel Permissionã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ã€å¿…è¦ã«å¿œã˜ã¦Gateã§è£œå®Œã™ã‚‹æ··åˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒæœ€ã‚‚å®Ÿç”¨çš„ã§ã‚ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é‹ç”¨åŠ¹çŽ‡ã¨é–‹ç™ºæŸ”è»Ÿæ€§ã‚’ä¸¡ç«‹ã§ãã‚‹ã€‚

ã¾ãŸã€æ¨©é™ç®¡ç†ã¯ä¸€åº¦å®Ÿè£…ã™ã‚Œã°å®Œäº†ã§ã¯ãªãã€çµ„ç¹”ã®å¤‰åŒ–ã‚„è¦ä»¶ã®é€²åŒ–ã«å¿œã˜ã¦ç¶™ç¶šçš„ãªè¦‹ç›´ã—ãŒå¿…è¦ã§ã‚ã‚‹ã€‚

ãªãŠã€ã“ã®è¨˜äº‹ã§ç´¹ä»‹ã—ãŸå†…å®¹ä»¥å¤–ã«ã‚‚ã€ã‚ˆã‚Šè‰¯ã„ãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚„ç•°ãªã‚‹è¦³ç‚¹ã‹ã‚‰ã®æ„è¦‹ã‚’ãŠæŒã¡ã®æ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‚‰ã€ãœã²ãŠèžã‹ã›ã„ãŸã ããŸã„ã€‚

## å‚è€ƒè¨˜äº‹
[Laravel Permission](https://spatie.be/docs/laravel-permission/v6/introduction)
[Laravel Authorization](https://laravel.com/docs/12.x/authorization)
