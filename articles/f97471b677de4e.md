---
title: "Laravel カスタムバリデーションルールで nullable フィールドを検証する方法"
emoji: "🦌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Laravel"]
published: false
---

## 問題

Laravel でカスタムバリデーションルールを作成した際、`nullable` ルールと組み合わせると、値が空（`null` や空文字）の場合にカスタムルールがスキップされてしまう。

### 発生した状況

`reason` フィールドに対して、特定のステータスが選択された場合のみ必須にするカスタムルールを作成した。

```php
'reason' => [
    'nullable',
    'string',
    'max:255',
    new ConditionalRequiredRule($this->input('statusId')),
],
```

期待する動作としては、ステータスが特定の値の場合、`reason` が空なら 422 エラーを返してほしい。

しかし実際の動作は、常に 200 OK が返され、バリデーションがスキップされた。

## 原因

Laravel のバリデーションでは、`nullable` ルールが指定されているフィールドの値が空の場合、後続のバリデーションルールはスキップされる。

これは Laravel のデフォルト動作であり、`ValidationRule` インターフェースを実装したカスタムルールは、デフォルトでは「暗黙的（implicit）」ではないため、空の値に対して実行されない。

### Laravel のバリデーション処理の流れ

1. `nullable` ルールをチェック
2. 値が `null` または空の場合、後続のルールをスキップ
3. カスタムルールは実行されない

## 解決方法

カスタムルールクラスに `$implicit` プロパティを追加し、`true` に設定する。

```php
class ConditionalRequiredRule implements ValidationRule
{
    /**
     * 値が空でもバリデーションを実行する
     */
    public bool $implicit = true;

    // ... 以下省略
}
```

### `$implicit = true` の効果

- 値が `null`、空文字、空配列などの「空」の状態でもバリデーションが実行される
- `required_if` や `required_unless` などの条件付き必須ルールと同様の動作になる

## 完成したカスタムルール

```php
<?php

declare(strict_types=1);

namespace App\Rules;

use App\Enums\StatusType;
use App\Models\Status;
use Closure;
use Illuminate\Contracts\Validation\ValidationRule;

class ConditionalRequiredRule implements ValidationRule
{
    /**
     * 値が空でもバリデーションを実行する
     */
    public bool $implicit = true;

    public function __construct(
        private readonly ?string $statusId,
    ) {}

    public function validate(string $attribute, mixed $value, Closure $fail): void
    {
        if (! $this->isReasonRequired()) {
            return;
        }

        if (empty($value)) {
            $fail('理由は必須です。');
        }
    }

    private function isReasonRequired(): bool
    {
        if ($this->statusId === null) {
            return false;
        }

        /** @var StatusType|null $statusType */
        $statusType = Status::find($this->statusId)?->type;

        return $statusType === StatusType::INACTIVE
            || $statusType === StatusType::PENDING;
    }
}
```

## 代替案

カスタムルールを作成せずに `Rule::requiredIf()` を使う方法もある。

```php
use Illuminate\Validation\Rule;

'reason' => [
    'nullable',
    'string',
    'max:255',
    Rule::requiredIf(function () {
        $statusId = $this->input('statusId');
        if ($statusId === null) {
            return false;
        }
        $statusType = Status::find($statusId)?->type;
        return $statusType === StatusType::INACTIVE
            || $statusType === StatusType::PENDING;
    }),
],
```

### カスタムルールを選ぶべきケース

以下のような場合はカスタムルールの方が適している。

- 同じ条件を複数のフィールドやフォームで再利用したい
- ロジックが複雑で単体テストしたい
- バリデーションメッセージを細かくカスタマイズしたい

## 条件付き必須ルールの使い分け

Laravel には条件付きで必須にするためのルールが複数用意されている。

| ルール | ユースケース |
|--------|-------------|
| `required` | 常に必須のフィールド |
| `required_if:field,value` | 別フィールドが特定の値の場合に必須（例: 支払い方法がクレジットカードならカード番号が必須） |
| `required_unless:field,value` | 別フィールドが特定の値でない場合に必須（例: 会員でなければ連絡先が必須） |
| `Rule::requiredIf()` | クロージャで複雑な条件を記述したい場合 |
| `sometimes` | 複数のルールを条件付きで動的に追加したい場合 |
| `exclude_if` / `exclude_unless` | 条件によってフィールド自体をバリデーション対象から除外したい場合 |

## まとめ
- `nullable` ルールが指定されたフィールドでは、値が空の場合にカスタムバリデーションルールがスキップされる
- カスタムルールクラスに `public bool $implicit = true` を追加することで、空の値でもバリデーションが実行される
- 単純な条件であれば `Rule::requiredIf()` や `required_if` で代用できる
- 再利用性やテスタビリティを重視する場合はカスタムルールが適している

## 参考

- [Laravel Validation - Implicit Extensions](https://laravel.com/docs/11.x/validation#implicit-extensions)
- [Laravel Validation - Conditionally Adding Rules](https://laravel.com/docs/11.x/validation#conditionally-adding-rules)
