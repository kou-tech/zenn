---
title: "Azure Easy Auth ã¨ Laravel ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰èªè¨¼ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ¦Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["php", "laravel", "Azure"]
published: false
---

Azure App Service ã® Easy Authï¼ˆçµ„ã¿è¾¼ã¿èªè¨¼ï¼‰ã¨ Laravel ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã‚’ä½µç”¨ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ãŸã€‚æœ¬è¨˜äº‹ã§ã¯ã€è¨­è¨ˆã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€å®Ÿè£…ä¸­ã«ç›´é¢ã—ãŸèª²é¡Œã€ãã—ã¦ãã®è§£æ±ºç­–ã«ã¤ã„ã¦è¨˜è¿°ã™ã‚‹ã€‚

## ã¯ã˜ã‚ã«

ä¼æ¥­å‘ã‘ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€èªè¨¼åŸºç›¤ã¨ã—ã¦ Microsoft Entra ID ã‚’æ¡ç”¨ã™ã‚‹ã‚±ãƒ¼ã‚¹ã¯å¤šã„ã€‚Azure App Service ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã€Easy Auth ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã ã‘ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã›ãšã«èªè¨¼ã‚’å®Ÿç¾ã§ãã‚‹ã€‚

ã—ã‹ã—ã€æ—¢å­˜ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«Easy Authã‚’å°å…¥ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¦ä»¶ãŒç”Ÿã˜ã‚‹ã€‚

- æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã‚’ä»£æ›¿æ‰‹æ®µã¨ã—ã¦æ®‹ã—ãŸã„ã€‚
- ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒãªã© Easy Auth ãŒåˆ©ç”¨ã§ããªã„ç’°å¢ƒã§ã‚‚å‹•ä½œã•ã›ãŸã„ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€ã“ã‚Œã‚‰ã®è¦ä»¶ã‚’æº€ãŸã—ã¤ã¤ã€å¾“æ¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã‚’ç¶­æŒã—ãªãŒã‚‰ Easy Auth ã«ã‚ˆã‚‹èªè¨¼ã‚’ä½µç”¨ã™ã‚‹ãŸã‚ã®è¨­è¨ˆã¨å®Ÿè£…ã«ã¤ã„ã¦è§£èª¬ã™ã‚‹ã€‚

## Easy Auth ã®ä»•çµ„ã¿

### èªè¨¼ãƒ•ãƒ­ãƒ¼ã®æ¦‚è¦

Easy Auth ã¯ Azure App Service ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã§å‹•ä½œã™ã‚‹èªè¨¼æ©Ÿèƒ½ã§ã‚ã‚‹ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«åˆ°é”ã™ã‚‹å‰ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¤œæŸ»ã—ã€æœªèªè¨¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ ID ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã€‚

èªè¨¼ãŒå®Œäº†ã™ã‚‹ã¨ã€Easy Auth ã¯ä»¥ä¸‹ã® HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«æ³¨å…¥ã™ã‚‹ã€‚

| ãƒ˜ãƒƒãƒ€ãƒ¼å | èª¬æ˜ |
|-----------|------|
| `X-MS-CLIENT-PRINCIPAL-NAME` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ UPN |
| `X-MS-CLIENT-PRINCIPAL-ID` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€æ„è­˜åˆ¥å­ï¼ˆGUIDï¼‰ |
| `X-MS-CLIENT-PRINCIPAL` | Base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚¯ãƒ¬ãƒ¼ãƒ æƒ…å ± |

é‡è¦ãªã®ã¯ã€ã“ã‚Œã‚‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¯å¤–éƒ¨ã‹ã‚‰å½è£…ã§ããªã„ã¨ã„ã†ç‚¹ã§ã‚ã‚‹ã€‚

> "External requests aren't allowed to set these headers, so they're present only if App Service sets them."
>
> â€” [Work with user identities in Azure App Service authentication](https://learn.microsoft.com/en-us/azure/app-service/configure-authentication-user-identities)

Azure App Service ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹éš›ã€å¤–éƒ¨ã‹ã‚‰ã® `X-MS-*` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã€‚ãã®ãŸã‚ã€ã“ã‚Œã‚‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ Easy Auth ã«ã‚ˆã£ã¦è¨­å®šã•ã‚ŒãŸã‚‚ã®ã¨ä¿¡é ¼ã§ãã‚‹ã€‚

### JWT ã¨ã®é–¢ä¿‚

Easy Auth ã¨èãã¨ JWTï¼ˆJSON Web Tokenï¼‰ã‚’é€£æƒ³ã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ãŒã€Laravel ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ JWT ã‚’ç›´æ¥æ‰±ã†å¿…è¦ãŒãªã„ã€‚JWT ã®æ¤œè¨¼ã¯ Azure App Service å´ã§å®Œçµã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯æ¤œè¨¼æ¸ˆã¿ã®çµæœãŒ HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ã€‚

ã“ã‚Œã¯è¨­è¨ˆä¸Šã®å¤§ããªåˆ©ç‚¹ã§ã‚ã‚‹ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ JWT ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å°å…¥ã—ãŸã‚Šã€ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’ç®¡ç†ã—ãŸã‚Šã™ã‚‹å¿…è¦ãŒãªã„ã€‚

## è¨­è¨ˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«ã‚ˆã‚‹æ©‹æ¸¡ã—

Easy Auth ã®èªè¨¼çµæœã‚’ Laravel ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã«æ©‹æ¸¡ã—ã™ã‚‹ãŸã‚ã€ã‚«ã‚¹ã‚¿ãƒ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’å®Ÿè£…ã—ãŸã€‚

```php
class EasyAuthMiddleware
{
    private const HEADER_NAME = 'X-MS-CLIENT-PRINCIPAL-NAME';

    public function handle(Request $request, Closure $next): Response
    {
        // æ—¢ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
        if (Auth::check()) {
            return $next($request);
        }

        // Easy Auth ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—
        $email = $request->header(self::HEADER_NAME);

        if ($email === null) {
            return $next($request);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã¨è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
        $user = User::where('email', $email)->first();

        if ($user !== null) {
            Auth::login($user);
        }

        return $next($request);
    }
}
```

ã“ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ Web ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚°ãƒ«ãƒ¼ãƒ—ã®å…ˆé ­ã«ç™»éŒ²ã™ã‚‹ã€‚

```php
// bootstrap/app.php
$middleware->web(prepend: [
    EasyAuthMiddleware::class,
]);
```

### ãªãœã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã‚’ä½µç”¨ã™ã‚‹ã®ã‹

ã€ŒEasy Auth ã§èªè¨¼ã•ã‚Œã¦ã„ã‚‹ãªã‚‰ã€æ¯å›ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚Œã°è‰¯ã„ã®ã§ã¯ï¼Ÿã€ã¨ã„ã†ç–‘å•ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚ä»Šå›ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã‚’ä½µç”¨ã™ã‚‹ç†ç”±ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã‚ã‚‹ã€‚

1. Easy AuthãŒåˆ©ç”¨ã§ããªã„ç’°å¢ƒã§å¾“æ¥ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç¶™ç¶šã—ã¦åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
2. æ—¢å­˜ã®Laravelã®èªè¨¼åŸºç›¤ã‚’ãã®ã¾ã¾æ´»ç”¨ã§ãã‚‹ã€‚


## ç›´é¢ã—ãŸèª²é¡Œã¨è§£æ±ºç­–

### èª²é¡Œâ‘  ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®å†èªè¨¼ãƒ«ãƒ¼ãƒ—

#### ç¾è±¡
ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚ã€ã™ãã«å†åº¦ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ãªã£ã¦ã—ã¾ã†ã€‚

#### åŸå› 
Laravel ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç ´æ£„ã—ã¦ã‚‚ã€Azure å´ã®èªè¨¼çŠ¶æ…‹ã¯ç¶­æŒã•ã‚Œã¦ã„ã‚‹ã€‚æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ Easy Auth ãŒå†åº¦ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ³¨å…¥ã—ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒè‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã¦ã—ã¾ã†ã€‚

#### è§£æ±ºç­–
Easy Auth ç’°å¢ƒã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ã«ã¯ã€`/.auth/logout` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ Microsoft Entra ID ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ URL ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã€‚
ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€Azure å´ã®èªè¨¼ Cookie ãŒå‰Šé™¤ã•ã‚Œã€ID ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‹ã‚‰ã‚‚é©åˆ‡ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã‚Œã‚‹ã€‚

### èª²é¡Œâ‘¡ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã® CORS ã‚¨ãƒ©ãƒ¼

#### ç¾è±¡

ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« CORS ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚

```
Access to XMLHttpRequest at 'https://login.windows.net/...'
from origin 'https://app.example.com' has been blocked by CORS policy
```

#### åŸå› 
å•é¡Œã¯ã€Inertia.js ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ AJAXï¼ˆXHRï¼‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã‚ã‚‹ã€‚AJAX ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã¨ã€ç•°ãªã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒ CORS ãƒãƒªã‚·ãƒ¼ã«é•åã™ã‚‹ã€‚

```
POST /logout (AJAX)
    â†“
302 Redirect â†’ /.auth/logout
    â†“
302 Redirect â†’ login.windows.net/...
    â†“
CORS ã‚¨ãƒ©ãƒ¼
```

#### è§£æ±ºç­–

`Inertia::location()` ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®é€šå¸¸ã®ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œã§ãã‚‹ã€‚

```php
public function destroy(Request $request): SymfonyResponse
{
    Auth::guard('web')->logout();
    $request->session()->invalidate();
    $request->session()->regenerateToken();

    if ($request->hasHeader('X-MS-CLIENT-PRINCIPAL-NAME')) {
        // é€šå¸¸ã® redirect() ã§ã¯ãªã Inertia::location() ã‚’ä½¿ç”¨
        return Inertia::location('/.auth/logout');
    }

    return redirect('/');
}
```

`Inertia::location()` ã¯ 409 Conflict ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ `X-Inertia-Location` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿”ã™ã€‚Inertia ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã“ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œå‡ºã—ã€`window.location` ã‚’ä½¿ç”¨ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Š CORS ã®å•é¡Œã‚’å›é¿ã§ãã‚‹ã€‚

### èª²é¡Œâ‘¢ axios ã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ã‚¢ã‚¦ãƒˆãŒæ©Ÿèƒ½ã—ãªã„

#### ç¾è±¡

`Inertia::location()` ã‚’å®Ÿè£…ã—ã¦ã‚‚ã€ä¾ç„¶ã¨ã—ã¦ CORS ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚

#### åŸå› 

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒ axios ã‚’ç›´æ¥ä½¿ç”¨ã—ã¦ã„ãŸã€‚

```ts
// å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰
const logout = async () => {
  await axios.post(route('logout'), {...})
    .then(() => {
      router.get(route('login'));
    });
};
```

axios ã¯ Inertia ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ç†è§£ã—ãªã„ã€‚409 ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã£ã¦ã‚‚ã€`X-Inertia-Location` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è§£é‡ˆã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ããªã„ã€‚

#### è§£æ±ºç­–

Inertia ã® `router` ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ãŸã€‚

```ts
const logout = () => {
  mutate(() => true, undefined, { revalidate: false });
  router.post(route('logout'));
};
```

ã“ã®ä¿®æ­£ã«ã‚ˆã‚Šã€Inertia ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ 409 ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é©åˆ‡ã«å‡¦ç†ã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ `/.auth/logout` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚


## ãƒ†ã‚¹ãƒˆã®å®Ÿè£…

Easy Auth ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã‚‚ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã§ãã‚‹ã€‚

```php
test('Easy Auth ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§è‡ªå‹•èªè¨¼ã•ã‚Œã‚‹', function () {
    $request = Request::create('/');
    $request->headers->set('X-MS-CLIENT-PRINCIPAL-NAME', 'test@example.com');

    $middleware = new EasyAuthMiddleware();
    $middleware->handle($request, fn () => new Response());

    expect(Auth::check())->toBeTrue();
    expect(Auth::user()->email)->toBe('test@example.com');
});
```

Inertia ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆã§ã¯ã€`X-Inertia` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã—ã¦ Inertia ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã€‚

```php
test('Easy Auth ç’°å¢ƒã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ã¨ Azure ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹', function () {
    $this->actingAs($user);

    $response = $this->withHeaders([
        'X-MS-CLIENT-PRINCIPAL-NAME' => 'test@example.com',
        'X-Inertia' => 'true',
    ])->post(route('logout'));

    // Inertia::location() ã¯ 409 ã‚’è¿”ã™
    $response->assertStatus(409);
    $response->assertHeader('X-Inertia-Location', '/.auth/logout');
});
```

## ã¾ã¨ã‚

Easy Auth ã¨ Laravel ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã‚’ä½µç”¨ã™ã‚‹ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰èªè¨¼ã‚’æ¬¡ã®æ–¹æ³•ã§å®Ÿè£…ã—ãŸã€‚

1. Easy Auth ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¤œå‡ºã—ã€Laravel ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã«æ©‹æ¸¡ã—ã™ã‚‹ã€‚
2. å¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«ã¯ `Inertia::location()` ã‚’ä½¿ç”¨ã—ã€CORS ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ã€‚
3. axios ã§ã¯ãªã Inertia ã® router ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Inertia ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã€‚

å€‹äººçš„ãªæ‰€æ„Ÿã¨ã—ã¦ã€Easy Auth ã¯ã€Œèªè¨¼ã‚’ç°¡å˜ã«ã™ã‚‹ã€ã¨ã„ã†è§¦ã‚Œè¾¼ã¿ã ãŒã€æ—¢å­˜ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨çµ„ã¿åˆã‚ã›ã‚‹å ´åˆã¯ãã‚Œãªã‚Šã®è€ƒæ…®ãŒå¿…è¦ã§ã‚ã‚‹ã€‚ç‰¹ã« SPA ã¨çµ„ã¿åˆã‚ã›ã‚‹å ´åˆã€AJAX ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨å¤–éƒ¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®ç›¸æ€§å•é¡Œã«æ³¨æ„ãŒå¿…è¦ã§ã‚ã‚‹ã€‚

ã—ã‹ã—ã€ä¸€åº¦ä»•çµ„ã¿ã‚’ç†è§£ã—ã¦ã—ã¾ãˆã°ã€éå¸¸ã«å¼·åŠ›ãªèªè¨¼åŸºç›¤ã‚’å°‘ãªã„ã‚³ãƒ¼ãƒ‰ã§å®Ÿç¾ã§ãã‚‹ã€‚JWT ã®ç®¡ç†ã‚„ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã¨ã„ã£ãŸç…©é›‘ãªå‡¦ç†ã‚’ Azure ã«ä»»ã›ã‚‰ã‚Œã‚‹ã®ã¯å¤§ããªãƒ¡ãƒªãƒƒãƒˆã§ã‚ã‚‹ã€‚

## å‚è€ƒæ–‡çŒ®

- [Work with user identities in Azure App Service authentication](https://learn.microsoft.com/en-us/azure/app-service/configure-authentication-user-identities) - Microsoft Learn
- [Authentication and Authorization - Azure App Service](https://learn.microsoft.com/en-us/azure/app-service/overview-authentication-authorization) - Microsoft Learn
- [Laravel 12.x Authentication](https://laravel.com/docs/12.x/authentication) - Laravel å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [Inertia.js - Redirects](https://inertiajs.com/redirects) - Inertia.js å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

